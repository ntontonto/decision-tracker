# Constellation View Up/Down Navigation Implementation

## 課題の洗い出し (Identified Challenges)

星座View（Constellation View）における上下ナビゲーションボタンの実装にあたり、以下の課題が予見されます。

### 1. ナビゲーション対象の定義と整合性
現在、星は以下のように整理されています：
- **水平方向 (Horizontal)**: 同じ「チェイン」（意思決定の系譜）に属する星。`PageView`で切り替え可能。
- **垂直方向 (Vertical)**: ソートモード適用時に、異なる「チェイン」の代表星（フォーカススター）が縦に並ぶ。

**課題**: 「上/下」ボタンを押した際、常に各チェインの「代表星」に遷移するのか、あるいは現在見ているノードの「上の位置にある星」を探すのか、挙動の定義が必要です。基本的には「ソートされたチェインを順に辿る」のが自然と考えられます。

### 2. ソート順序の動的な追跡
現在の実装では `_calculateChainMetas` 内でソートが行われますが、その結果（順序）は `Map<String, _ChainMeta>` に格納されており、インデックスによるアクセスが容易ではありません。
**課題**: 「現在のチェインの次/前」を即座に特定するために、ソート済みのチェインIDリストを保持する仕組みが必要です。

### 3. 非ソート時の挙動
ソートされていない状態（自由配置モード）では、星は物理演算に基づいてランダムに配置されています。
**課題**: ソートモードが `none` の場合に、上下ボタンを表示し続けるのか、あるいは無効化（非表示）にするのかの判断が必要です。

### 4. UI配置と既存ジェスチャーとの干渉
カードの上部には現在、ドラッグハンドル（バー）やヘッダー情報（種別、日付など）があります。
**課題**: 
- ボタンを「カードの上」に配置する場合、カードの**外側（オーバーレイ層）**に置くのか、カードの**内側（ヘッダー部分）**に置くのか。
- カードが拡大（Expanded）された際、ボタンも一緒にスクロールして見えなくなるのか、あるいは固定位置（Sticky）にするのか。
- カードを閉じるための下フリックジェスチャーとの誤操作を防ぐ配置。

### 5. カメラとPageViewの同期
上下ボタンでチェインを切り替えた際、以下の処理を同時に行う必要があります：
- 3D空間のカメラを新しい星へ移動
- カード内の `PageView` を、新しいチェインの適切なインデックス（通常はフォーカス星）にリセット

### 6. 境界条件（端の処理）
一番上や一番下のチェインに到達した際、ボタンをグレーアウトするか非表示にするか。

---

## 提案する実装アプローチ

1. **データ構造の拡張**: `sortedChainIds` リストを State に追加し、ソート実行時にこれを更新する。
2. **ナビゲーション関数の統合**: `_focusNextChain(bool forward)` のような関数を作成し、カメラ移動と PageView リセットを一括管理する。
3. **UIの実装**: `ConstellationNodeCard` の外部（`_buildDetailOverlay` 内）に、フローティングボタンとして配置することで、カードの状態（スクロール位置など）に依存せず、常にナビゲーションを可能にする。
